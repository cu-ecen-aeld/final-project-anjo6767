#!/bin/sh
case "$1" in
  start)
    echo "Loading aesdchar"
    # Try insmod from the Buildroot 'extra' path, fall back to modprobe
    insmod /lib/modules/$(uname -r)/extra/aesdchar.ko || modprobe aesdchar

    # Create /dev/aesdchar node if it doesn't exist (systems without udev/mdev)
    if [ ! -e /dev/aesdchar ]; then
        major=$(awk '$2=="aesdchar"{print $1}' /proc/devices)
        if [ -n "$major" ]; then
            echo "Creating /dev/aesdchar (major $major)"
            mknod /dev/aesdchar c "$major" 0
            chmod 666 /dev/aesdchar
        else
            echo "Could not find aesdchar"
        fi
    fi

    echo "aesdchar loaded."
    ;;

  stop)
    echo "Unloading aesdchar"
    # Do NOT remove /dev/aesdchar per assignment requirement
    rmmod aesdchar 
    echo "aesdchar unloaded."
    ;;

  restart)
    $0 stop
    $0 start
    ;;

  *)
    echo "Usage: $0 {start|stop|restart}"
    exit 1
    ;;
esac

exit 0

